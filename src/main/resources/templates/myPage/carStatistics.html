<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">

<head>
  <title>MyCar 통계</title>
</head>

<div layout:fragment="content">

  <div class="row mt-3">

    <div class="col">
      <div class="card">
        <div class="card-header">
          Car 통계
        </div>

        <div class="card-body">

          <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="consume-tab" data-bs-toggle="tab" data-bs-target="#consume" type="button" role="tab" aria-controls="consume" aria-selected="true">월별 지출</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="fuelEff-tab" data-bs-toggle="tab" data-bs-target="#fuelEff" type="button" role="tab" aria-controls="fuelEff" aria-selected="false">월별 평균 연비</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="fuelAmount-tab" data-bs-toggle="tab" data-bs-target="#fuelAmount" type="button" role="tab" aria-controls="fuelAmount" aria-selected="false">월별 주유량</button>
            </li>
          </ul>
          <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="consume" role="tabpanel" aria-labelledby="consume-tab">

              <div class="row mt-3">
                <div class="input-group-prepend">
                  <select name="selectYearName" id="selectYear">
                    <option value="2024" selected>2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                    <option value="2028">2028</option>
                  </select>

                  <button type="button" class="btn btn-info refreshBtn">조회</button>
                </div>
              </div>

              <div class="row mt-3">
                <div>
                  <canvas id="consumeChart"></canvas>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="fuelEff" role="tabpanel" aria-labelledby="fuelEff-tab">
              <div class="row mt-3">


              </div>
            </div>
            <div class="tab-pane fade" id="repair" role="tabpanel" aria-labelledby="repair-tab">
              <div class="row mt-3">

              </div>
            </div>
            <div class="tab-pane fade" id="fuelAmount" role="tabpanel" aria-labelledby="fuelAmount-tab">...</div>
          </div>

        </div><!-- <div class="card-body">-->
      </div>
    </div><!--    <div class="col">-->

    <a th:href="|@{/myPage/carDetail(carId=${carId}, userName=${#authentication.principal.username} )}|" class="text-decoration-none">
      <button type="button" class="btn btn-primary">back</button>
    </a>

  </div>


  <!--    axios 라이브러리 추가-->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/js/history.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</div> <!--<div layout:fragment="content">-->

<script layout:fragment="script" th:inline="javascript">

  let page = 1
  let size = 5

  const currentUser = [[${#authentication.principal.username}]]
  const carId = [[${carId}]]

  const selectYear = document.querySelector('#selectYear');
  const refreshBtn = document.querySelector(".refreshBtn")


  getConsumeList()



  refreshBtn.addEventListener("click", function(e) {
    getConsumeList()
  },false)

  var triggerTabList = [].slice.call(document.querySelectorAll('#myTab button'))
  triggerTabList.forEach(function (triggerEl) {
    var tabTrigger = new bootstrap.Tab(triggerEl)

    triggerEl.addEventListener('click', function (event) {
      event.preventDefault()

      const target = event.target
      const targetId = target.getAttribute("data-bs-target")

      if( targetId === "#consume" ){
        getConsumeList()
      }
      // else if(targetId === "#fuelEff" ){
      //   getFuelEffList()
      // }
      // else if(targetId === "#fuelAmount"){
      //   getFuelAmountList()
      // }

      tabTrigger.show()
    })
  })

  function getConsumeList(){

    getConsumeHistory({carId, selectYear:selectYear.value}).then(data => {

      console.log(data)

      printConsumeList(data) // 목록 처리

    }).catch(e=>{
      console.error(e)
    })
  }


  function printConsumeList(dtoList) {

    const arrMonth = Array.from({length: 12}, (item, index) =>
            String(index + 1).padStart(2, "0"));   // 숫자 앞자리 0으로 채우기

    const arrCost = Array.from({length: 12}, () => 0);   // 월별 비용 저장

    dtoList.forEach(function (e, i) {
      arrCost[parseInt(e.replaceDate)-1] = e.replacePrice
    })

    console.log(arrCost)

    ///////// 차트 /////////
    const ctx = document.getElementById('consumeChart');

    let chartStatus = Chart.getChart(ctx);
    if (chartStatus !== undefined) {
      chartStatus.destroy();
    }

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: arrMonth,
        datasets: [{
          label: '# of Votes',
          data: arrCost,
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

</script>