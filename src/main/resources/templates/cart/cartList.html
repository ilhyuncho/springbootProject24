<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">

<div layout:fragment="content">

    <div class="row mt-3">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <!--          HTML 테그의 속성이 아니라 HTML 콘텐츠 영역안에서 직접 데이터를 출력하고 싶으면 다음과 같이 [[...]] 를 사용하면 됩니다.-->
<!--                    [[${pageRequestDto.size}]]-->
                </div>
                <div class="card-body">
                    <h5 class="card-title">장바구니 List</h5>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <ul class="list-group cartList">
                                <!-- 장바구니 리스트 영역-->
                            </ul>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col">
                            <ul class="pagination cartListPaging">
                                <!--                댓글 페이징 처리-->
                            </ul>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <table id="my-table">
                            <thead>
                                <tr>
                                    <th scope="col">cartId</th>
                                    <th scope="col">shopItemId</th>
                                    <th scope="col">itemName</th>
                                    <th scope="col">itemCount</th>
                                    <th scope="col">option1</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>

                        </table>
                    </div>

                    <body>
                    <div id="showme"></div>
                    </body>


                </div><!-- <div class="card-body">-->
            </div>
        </div>
    </div>

    <div class="modal modifyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title cartHeader"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text">상품 이름</span>
                        <input type="text" class="form-control cartIdText" readonly>
                    </div>
                    <div class="input-group mb-3">
                        <span class="input-group-text">구매 갯수</span>
                        <input type="text" class="form-control cartItemCount">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info modifyBtn">Modify</button>
                    <button type="button" class="btn btn-danger removeBtn">Remove</button>
                    <button type="button" class="btn btn-outline-dark closeModifyBtn">Close</button>
                </div>

            </div>
        </div>
    </div>

    <!--    axios 라이브러리 추가-->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/cart.js"></script>
</div>

<script layout:fragment="script" th:inline="javascript">

    // 페이지 번호 클릭
    let page = 1
    let size = 5

    const currentUser = [[${#authentication.principal.username}]]

    const modifyModal = new bootstrap.Modal(document.querySelector(".modifyModal"))
    const cartIdText = document.querySelector(".cartIdText")
    const cartItemCount = document.querySelector(".cartItemCount")
    const cartList = document.querySelector('.cartList')        // 목록 DOM
    const cartListPaging = document.querySelector('.cartListPaging')  // 페이지 목록 DOM
    const modifyBtn = document.querySelector(".modifyBtn")
    const removeBtn = document.querySelector(".removeBtn")
    const closeModifyBtn = document.querySelector(".closeModifyBtn")

    function MyDataa(mkey,mtitle,mvalue){
        this.key = mkey
        this.title = mtitle
        this.value = mvalue
    }

    var mmList = [
        new MyDataa('key1','제목1','values1'),
        new MyDataa('key2','제목2','valueqs'),
        new MyDataa('key3','제목w 3','valuest'),
        new MyDataa('key4','제목4','valu123 es'),
        new MyDataa('key5','제목5','valuaa es'),
        new MyDataa('key6','제목6','valu des'),
        new MyDataa('key7','제목7','valu de11s'),
        new MyDataa('key8','제목8','valuasdes')
    ]

    // makeTable('#showme',mmList);

    function makeTable(stringSelector ,listData){
        var d = document.querySelector(stringSelector)
        while (d.firstChild) {
            d.removeChild(d.firstChild);
        }

        var colnum = 4;
        var tbl = document.createElement('table');
        tbl.setAttribute('text-align', 'center')
        tbl.style.width = '100%'
        tbl.border = 1
        var colgroup = document.createElement('colgroup')
        var tbody = document.createElement('tbody')
        for (var i = 0; i<colnum; i++){
            var col = document.createElement('col')
            col.attributes.width = '25%'
            colgroup.appendChild(col)
        }
        var tr = document.createElement('tr')
        listData.forEach(function(e,i){
            var tTD = document.createElement('td')
            tTD.appendChild(document.createTextNode(e.title))
            var vTD = document.createElement('td')
            if (Array.isArray(e.value)){
                var ultag = document.createElement('ul')
                e.value.forEach((arrayValue)=>{
                    var litag = document.createElement('li')
                    litag.appendChild(document.createTextNode(arrayValue))
                    ultag.appendChild(litag)
                })
                vTD.appendChild(ultag)
            } else {
                vTD.appendChild(document.createTextNode(e.value))
            }

            tr.appendChild(tTD)
            tr.appendChild(vTD)
            if (e.key === 'key7'||e.key === 'key8'){
                vTD.setAttribute('colSpan', '3')
                tbody.appendChild(tr)
                tr = document.createElement('tr')
            } else {
                if(i%2 != 0){
                    tbody.appendChild(tr)
                    tr = document.createElement('tr')
                }
            }
        })
        tbl.appendChild(colgroup)
        tbl.appendChild(tbody)
        d.appendChild(tbl)
    }

    function addRow(tableID, dtoList) {
        // Get a reference to the table
        let tableRef = document.getElementById(tableID);

        if(dtoList && dtoList.length > 0) {
            dtoList.forEach(function (e, i) {
                console.log('e : ' + e)
                console.log('key : ' + e.key)

                const arr = [e.cartId, e.shopItemId, e.itemName, e.itemCount, e.option1]

                let newRow = tableRef.insertRow(-1);

                for (var i = 0; i<arr.length; i++){
                    let newCell = newRow.insertCell(i);
                    let newText = document.createTextNode(arr[i]);
                    newCell.appendChild(newText);
                }
            })
        }

        // if(dtoList && dtoList.length > 0){
        //
        //     for(const dto of dtoList){
        //         let newRow = tableRef.insertRow(-1);
        //
        //         let newCell1 = newRow.insertCell(0);
        //         let newText1 = document.createTextNode(dto.cartId);
        //         newCell1.appendChild(newText1);
        //
        //         let newCell2 = newRow.insertCell(1);
        //         let newText2 = document.createTextNode(dto.shopItemId);
        //         newCell2.appendChild(newText2);
        //
        //         let newCell3 = newRow.insertCell(2);
        //         let newText3 = document.createTextNode(dto.itemName);
        //         newCell3.appendChild(newText3);
        //
        //         let newCell4 = newRow.insertCell(3);
        //         let newText4 = document.createTextNode(dto.itemCount);
        //         newCell4.appendChild(newText4);
        //
        //         let newCell5 = newRow.insertCell(4);
        //         let newText5 = document.createTextNode(dto.option1);
        //         newCell5.appendChild(newText5);
        //
        //     }
        // }

    }

    // Call addRow() with the table's ID
   // addRow("my-table");


    function printCartList(page,size,goLast){
        // getList(currentUser) 호출시 Promise가 반환
        getList({page,size,currentUser}).then(data => {
            // console.log(data)
            printList(data.dtoList) // 목록 처리
            printPages(data)        // 페이지 처리

        }).catch(e=>{
            console.error(e)
        })
    }

    printCartList(1,5,true)

    function printList(dtoList){    // 목록 출력
        let str = '';

        if(dtoList && dtoList.length > 0){
            for(const dto of dtoList){
                str += `<li class="list-group-item d-flex cartItem">
                    <span class="col-2">${dto.cartId}</span>
                    <span class="col-2">${dto.shopItemId}</span>
                    <span class="col-2">${dto.itemName}</span>
                    <span class="col-2">${dto.itemCount}</span>
                    <span class="col-2">${dto.option1}</span>
                    <span class="col-2" data-cartId="${dto.cartId}" data-itemCount="${dto.itemCount}">수정</span>
                    </li>`
            }
        }
        cartList.innerHTML = str

        addRow("my-table", dtoList)
    }

    function printPages(data){
        let pageStr = '';

        if(data.prev){
            pageStr += `<li class="page-item"><a class="page-link" data-page="${data.start-1}">PREV</a></li>`
        }
        for(let i = data.start; i <= data.end; i++){
            pageStr += `<li class="page-item ${i == data.page ? "active":""} "><a class="page-link" data-page="${i}">${i}</a></li>`
        }
        if(data.next){
            pageStr += `<li class="page-item"><a class="page-link" data-page="${data.end+1}">NEXT</a></li>`
        }
        cartListPaging.innerHTML = pageStr
    }

    cartList.addEventListener("click", function(e){     // 장바구니 상품 정보 수정 ( & 삭제 )
        e.preventDefault()
        e.stopPropagation()

        const target = e.target

        if(!target || target.tagName !== 'SPAN'){
            return
        }

        const cartId = target.getAttribute("data-cartId")
        const itemCount = target.getAttribute("data-itemCount")

        if(!cartId || itemCount <= 0){
            return
        }

        cartIdText.value = cartId
        cartItemCount.value = itemCount

        modifyModal.show()

        // getReply(rno).then(reply => {
        //     console.log(reply)
        //     cartHeader.innerHTML = reply.rno
        //     modifyText.value = reply.replyText
        //
        //     modifyModal.show()
        //
        //
        //
        // }).catch(e => alert('error'))

    }, false)

    modifyBtn.addEventListener("click", function(e) {
        const cartId = cartIdText.value
        const itemCount = cartItemCount.value

        const itemObj = {
            cartId:cartId,
            itemCount:itemCount
        }

        modifyCartItem(itemObj).then(result=>{
            alert(result.cartId + '상품이 수정 되었습니다')

            cartIdText.value = ''
            cartItemCount.value = ''
            modifyModal.hide()

            printCartList(1,5,true)
        }).catch(e=>{
            console.log(e)
        })
    },false)

    removeBtn.addEventListener("click", function(e) {
        const cartId = cartIdText.value

        removeCartItem(cartId).then(result=>{
            alert(result.cartId + '상품이 삭제 되었습니다')

            cartIdText.value = ''
            modifyModal.hide()

            printCartList(1,5,true)
        }).catch(e=>{
            console.log(e)
        })
    },false)

    closeModifyBtn.addEventListener("click", function(e){
        modifyModal.hide()
    },false)

    cartListPaging.addEventListener("click", function(e){

        e.preventDefault()
        e.stopPropagation()

        const target = e.target
        if(!target || target.tagName !== 'A'){
            return
        }
        page = target.getAttribute("data-page")
        printCartList(page,size)

    },false)




    // clear 버튼 클릭 이벤트 begin ------------------
    // document.querySelector(".clearBtn").addEventListener("click", function(e){
    //
    //     console.log("clearBtn.click()~~~~")
    //
    //     e.preventDefault()
    //     e.stopPropagation()
    //
    //     self.location = '/dashBoard/carList'
    // },false)
    // clear 버튼 클릭 이벤트 end ------------------



</script>
